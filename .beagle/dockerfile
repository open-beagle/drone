ARG BASE

FROM ${BASE}

ARG AUTHOR
ARG VERSION

LABEL maintainer=${AUTHOR} version=${VERSION}

EXPOSE 80 443
VOLUME /data

# RUN [ ! -e /etc/nsswitch.conf ] && echo 'hosts: files dns' >/etc/nsswitch.conf

ARG TARGETOS
ARG TARGETARCH

ENV GODEBUG netdns=go
ENV XDG_CACHE_HOME /data
ENV DRONE_DATABASE_DRIVER sqlite3
ENV DRONE_DATABASE_DATASOURCE /data/database.sqlite
ENV DRONE_RUNNER_OS=${TARGETOS}
ENV DRONE_RUNNER_ARCH=${TARGETARCH}
ENV DRONE_SERVER_PORT=:80
ENV DRONE_SERVER_HOST=localhost
ENV DRONE_DATADOG_ENABLED=false

ADD release/${TARGETOS}/${TARGETARCH}/drone-server /bin/
ENTRYPOINT ["/bin/drone-server"]
